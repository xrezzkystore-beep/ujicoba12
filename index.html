<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>XREZZKYSTORE RNG GIVEAWAY</title>
<style>
body{
 margin:0;
 background:radial-gradient(circle,#1f6f6f,#020b0b);
 font-family:Arial,Helvetica,sans-serif;
 color:#fff;
 display:flex;
 justify-content:center;
}
.box{
 width:360px;
 margin:30px auto;
 background:#071414;
 border-radius:18px;
 padding:20px;
 box-shadow:0 0 25px #00ffd5;
 display:flex;
 flex-direction:column;
 align-items:center;
}
h2{
 text-align:center;
 color:#00ffd5;
 margin:5px 0;
 cursor:pointer;
}
input,button,select,textarea{
 width:100%;
 margin-top:10px;
 padding:10px;
 border-radius:8px;
 border:none;
 box-sizing:border-box;
 font-size:14px;
}
button{
 background:#00ffd5;
 font-weight:bold;
 cursor:pointer;
}
#redeemBtn{
 width:100px;
 font-size:14px;
 padding:10px;
 border-radius:8px;
 margin-left:10px;
}
#wheelBox{
 position:relative;
 width:280px;
 height:280px;
 margin:20px auto;
}
#wheel{
 width:100%;
 height:100%;
 border-radius:50%;
 border:8px solid #00ffd5;
 transition: transform 4s cubic-bezier(.25,.1,.25,1);
}
#arrow{
 position:absolute;
 bottom:-28px;
 left:50%;
 transform:translateX(-50%);
 font-size:24px;
 color:#fff;
 text-shadow:0 0 8px #00ffd5;
 z-index:10;
}
#eventIndicator{
 margin-top:6px;
 font-size:13px;
 font-weight:bold;
 padding:6px 10px;
 border-radius:8px;
 text-align:center;
}
#eventScheduleInfo{
 margin-top:6px;
 font-size:12px;
 color:#00ffd5;
 text-align:center;
}
#eventTimer{
 margin-top:4px;
 font-size:13px;
 color:#ffcc66;
 text-align:center;
}
#result{
 margin-top:15px;
 font-size:16px;
 font-weight:bold;
 text-align:center;
}
.log{
 background:#000;
 padding:10px;
 height:120px;
 overflow:auto;
 font-size:12px;
 margin-top:20px;
 width:100%;
 border-radius:8px;
}
#globalWinners, #infoBoard{
 background:#020b0b;
 padding:10px;
 overflow:auto;
 font-size:12px;
 margin-top:10px;
 width:100%;
 border-radius:8px;
 border:1px solid #00ffd5;
 max-height:120px;
}
#exportStatus{
 margin-top:6px;
 font-size:12px;
 color:#00ffd5;
 text-align:center;
}
#winnersStatus{
 margin-top:6px;
 font-size:13px;
 color:#ffcc00;
 text-align:center;
}
small{
 color:#aaa;
 margin-top:8px;
 display:block;
 text-align:center;
}
#claimBtn{
 background:#25D366;
 color:#000;
 margin-top:10px;
 display:none;
 width:100%;
}
#adminPanel{
 display:none;
 background:#020b0b;
 padding:10px;
 border-radius:10px;
 margin-top:15px;
 border:1px solid #00ffd5;
 width:100%;
}
#adminPanel button, #adminPanel textarea, #adminPanel input{
 margin-top:5px;
}
.code-wrapper{
 display:flex;
 width:100%;
 align-items:center;
}
.code-wrapper input{
 flex:1;
}

/* Additional small styles for admin manager UI */
#wheelManager{ margin-top:10px; border-top:1px solid #00ffd5; padding-top:10px; }
.wheel-item{ display:flex; gap:6px; align-items:center; margin-bottom:6px; }
.wheel-item input{ padding:6px; font-size:13px; }
.wheel-item .label-input{ flex:1; }
.wheel-item select{ width:100px; }
.wheel-item .weight-input{ width:60px; padding:6px; text-align:center; }
.wheel-item button{ width:60px; padding:6px; font-size:12px; }
#eventControls{ display:flex; gap:6px; align-items:center; margin-top:8px; flex-wrap:wrap; }
#eventStatus{ font-weight:bold; color:#00ffd5; margin-left:6px; }

/* Export modal */
#exportModal{
 display:none;
 position:fixed;
 left:0;
 top:0;
 width:100%;
 height:100%;
 background:rgba(0,0,0,0.6);
 z-index:9999;
 align-items:center;
 justify-content:center;
}
#exportContent{
 width:320px;
 background:#071414;
 border:1px solid #00ffd5;
 padding:12px;
 border-radius:10px;
 color:#fff;
}
#exportContent textarea{
 height:180px;
 background:#000;
 color:#fff;
 padding:8px;
 font-size:13px;
 border-radius:6px;
}
#exportButtons{ display:flex; gap:8px; margin-top:8px; }
#exportButtons button{ flex:1; }

/* admin small grid */
.admin-row{ display:flex; gap:6px; }
.admin-row > *{ flex:1; }
.mode-flag{ display:flex; align-items:center; gap:6px; margin-top:6px; color:#00ffd5; font-weight:bold; }
.mode-flag input{ width:auto; }
.small-btn{ padding:8px; font-size:13px; border-radius:6px; }

/* public panel */
#publicPanel{ display:none; width:100%; margin-top:12px; background:rgba(0,0,0,0.06); border-radius:8px; padding:10px; box-sizing:border-box; text-align:center; }
#publicPanel .pub-row{ margin-bottom:6px; }
#publicWinnersList{ text-align:left; max-height:120px; overflow:auto; padding:6px; background:rgba(0,0,0,0.03); border-radius:6px; }

 /* small improvement for spin button placed below wheel */
#spinBtn{
 margin-top:12px;
 max-width:220px;
 width:100%;
 align-self:center;
}
</style>
</head>
<body>
<div class="box">
<h2 id="title">XREZZKYSTORE</h2>
<p style="text-align:center;font-size:12px">RNG GIVEAWAY SYSTEM</p>

<input id="name" placeholder="Nama (1x saja)">

<div class="code-wrapper">
 <input id="code" placeholder="Kode tambahan spin (opsional)">
 <button id="redeemBtn">Redeem</button>
</div>

<!-- tombol SPIN dipindahkan ke bawah wheel (sesuai permintaan) -->

<!-- NEW: Public event ON/OFF indicator (visible on public page too) -->
<div id="eventIndicator" aria-live="polite">EVENT: LOADING...</div>

<div id="eventScheduleInfo"></div>
<div id="eventTimer"></div>

<div id="wheelBox">
 <canvas id="wheel" width="280" height="280"></canvas>
 <div id="arrow">‚¨ÜÔ∏è</div>
</div>

<!-- SPIN button now berada di bawah wheel -->
<button id="spinBtn">üåÄ SPIN RNG</button>

<div id="result"></div>
<button id="claimBtn">üì© KLAIM HADIAH</button>

<small id="spinInfo"></small>
<div class="log" id="log"></div>
<div id="infoBoard"><b>INFO EVENT:</b><br>Loading...</div>
<div id="globalWinners"><b>Pemenang:</b><br>Loading...</div>
<div id="winnersStatus"></div>

<!-- Public panel (appears on ?public=1 or when publicUrl matches) -->
<div id="publicPanel" aria-hidden="true">
  <div class="pub-row" id="publicStatus"><b>Status:</b> Loading...</div>
  <div class="pub-row" id="publicSchedule">Waktu event: -</div>
  <div class="pub-row" id="publicLastWinner">Pemenang terakhir: -</div>
  <div id="publicWinnersList">Belum ada pemenang</div>
  <div style="margin-top:8px;">
    <button id="publicSpinBtn" style="min-width:120px">üåÄ SPIN (Publik)</button>
  </div>
</div>

<div id="adminPanel">
 <b>üîí ADMIN PANEL</b>

 <div style="margin-top:6px;"><small style="color:#aaa">Mode:</small></div>
 <div class="mode-flag">
   <label><input type="radio" name="mode" id="modeTesting" value="testing"> Testing</label>
   <label><input type="radio" name="mode" id="modeRequired" value="required"> Wajib Isi</label>
 </div>

 <textarea id="adminInfo" placeholder="Tulis info event disini..."></textarea>
 <button id="updateInfoBtn">üíæ Update Info Event</button>

 <div class="admin-row">
   <input id="maxWinnerGlobal" placeholder="Max Pemenang Global">
   <input id="maxWinDevice" placeholder="Max Hadiah Per Device">
 </div>
 <div class="admin-row">
   <input id="maxSpinDevice" placeholder="Max Spin Per Device">
   <input id="freeSpinNewUser" placeholder="Free Spin untuk User Baru (angka)">
 </div>

 <div style="display:flex;gap:6px;">
   <button id="applySettingsBtn" class="small-btn">üîÅ Terapkan Settings</button>
   <button id="toggleEventBtn" class="small-btn">TURN OFF</button>
   <!-- Separate ON / OFF buttons as requested -->
   <button id="eventOnBtn" class="small-btn" style="background:#22c55e;color:#000">EVENT ON</button>
   <button id="eventOffBtn" class="small-btn" style="background:#ef4444;color:#fff">EVENT OFF</button>
 </div>

 <div style="margin-top:8px;">
   <button id="resetAllDataBtn" style="background:#ff4444;color:#fff">‚ö†Ô∏è RESET SEMUA DATA</button>
   <small style="color:#aaa">Hapus semua spin & pemenang (kode redeem tetap ada). Akan meminta konfirmasi.</small>
 </div>

 <div style="margin-top:10px;">
   <button id="resetSpinBtn">‚ôª Reset Spin Semua User (local)</button>
   <button id="restartWinnersBtn">üîÑ Reset Pemenang (firebase)</button>
 </div>

 <div style="margin-top:10px;">
   <input id="newCode" placeholder="Kode Baru">
   <input id="newCodeSpin" placeholder="Spin tambahan">
   <button id="addCodeBtn">‚ûï Tambah Code</button>
   <button id="resetCodesBtn">üßπ Reset SEMUA CODE (firebase)</button>
 </div>

 <div style="margin-top:10px;border-top:1px solid #00ffd5;padding-top:10px;">
   <b>üé° Wheel Manager</b>
   <div id="wheelList">Loading...</div>
   <input id="newWheelLabel" placeholder="Nama hadiah baru">
   <select id="newWheelType"><option value="win">HADIAH</option><option value="lose">ZONK</option></select>
   <input id="newWheelWeight" placeholder="Weight" value="1">
   <button id="addWheelItemBtn">‚ûï Tambah Item Wheel</button>
 </div>

 <div style="margin-top:10px;border-top:1px solid #00ffd5;padding-top:10px;">
   <b>‚è± Schedule (opsional)</b>
   <div style="font-size:12px;color:#aaa">Jika aktif, event akan otomatis ON/OFF sesuai jadwal. Wajib diisi jika Mode Wajib aktif.</div>
   <input id="eventStart" type="datetime-local" placeholder="Tanggal & Jam Mulai">
   <input id="eventEnd" type="datetime-local" placeholder="Tanggal & Jam Berakhir">
   <label style="margin-top:6px;"><input id="enableSchedule" type="checkbox"> Aktifkan Schedule (Auto ON/OFF)</label>
   <div style="display:flex;gap:6px;margin-top:6px;">
     <button id="setScheduleBtn">üíæ Set Schedule</button>
     <button id="clearScheduleBtn">üóë Hapus Schedule</button>
   </div>
 </div>

 <div style="margin-top:10px;border-top:1px solid #00ffd5;padding-top:10px;">
   <b>üîó Public Page</b>
   <input id="publicUrl" placeholder="Public Page URL (kosong = default)">
   <div style="display:flex;gap:6px;margin-top:6px;">
     <button id="setPublicUrlBtn">üíæ Set Public URL</button>
     <button id="openPublicBtn">üåê Buka Halaman Publik</button>
     <button id="copyPublicBtn">üìã Salin Link</button>
   </div>
 </div>

 <div style="margin-top:10px;border-top:1px solid #00ffd5;padding-top:10px;">
   <b>üì§ Export</b>
   <button id="exportBtn">EXPORT PEMENANG</button>
   <div id="exportStatus"></div>
 </div>

 <div style="margin-top:10px;">
   <button id="resetBtn">‚ùå Hapus Semua (User & Pemenang)</button>
 </div>

</div>
</div>

<!-- EXPORT MODAL -->
<div id="exportModal">
 <div id="exportContent">
   <div style="font-weight:bold;margin-bottom:6px">EXPORT PEMENANG</div>
   <textarea id="exportArea" readonly></textarea>
   <div id="exportButtons">
     <button id="copyExportBtn">Copy Semua</button>
     <button id="closeExportBtn">Tutup</button>
   </div>
 </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ================= CONFIG & STATE =================
const ADMIN_PIN="XREZZKY STORE0930";
const ADMIN_WA="6288293064112";
let MAX_SPIN_PER_USER = 0;
let MAX_WIN_PER_DEVICE = 2;
let MAX_WINNER_GLOBAL = 10;
const DEFAULT_FREE_SPIN_NEW_USER = 5;

let prizes=[
 {label:"ZONK",win:false, weight:1},
 {label:"CLASS(1)",win:true, weight:1},
 {label:"ZONK",win:false, weight:1},
 {label:"TRAIN(1)",win:true, weight:1},
 {label:"ZONK",win:false, weight:1},
 {label:"TRAIN(1)+CLASS(1)",win:true, weight:1}
];
let CODES={};
let EVENT_ON = true;
let REQUIRE_PARAMS = false; // mode required/wajib
let SCHEDULE_ENABLED = false;
let SCHEDULE_START = 0; // epoch ms
let SCHEDULE_END = 0;
let PUBLIC_URL = "";

// ================= FIREBASE =================
const firebaseConfig = {
 apiKey: "AIzaSyD85JE0QCaey1o4AUQtp24aGqNmx3AtbmA",
 authDomain: "xrezzkystore-rng.firebaseapp.com",
 databaseURL: "https://xrezzkystore-rng-default-rtdb.asia-southeast1.firebasedatabase.app",
 projectId: "xrezzkystore-rng",
 storageBucket: "xrezzkystore-rng.appspot.com",
 messagingSenderId: "304889774590",
 appId: "1:304889774590:web:5d52c2485ca2137ad480af",
 measurementId: "G-MQ71QRYHV7"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// ================= STORAGE & DEVICE =================
const deviceId=localStorage.getItem("devId") || (()=>{ const id="dev-"+Math.random().toString(36).slice(2); localStorage.setItem("devId",id); return id; })();
let spinData=JSON.parse(localStorage.getItem("spinData")||"{}");
let usedCodes=JSON.parse(localStorage.getItem("usedCodes")||"{}");
let lockedName=localStorage.getItem("lockedName");
let hasWon=localStorage.getItem("hasWon")==="true";
let totalSpin=JSON.parse(localStorage.getItem("totalSpin")||"0");
let lastPrize=null;
let lastResetAll = parseInt(localStorage.getItem("lastResetAll")||"0",10) || 0;
if(!spinData[deviceId]) spinData[deviceId]=0;

// ================= SYNC SETTINGS FROM FIREBASE =================
const settingsRef = db.ref("settings");
settingsRef.on("value", snap => {
  const s = snap.val() || {};

  if(typeof s.eventOn !== "undefined") EVENT_ON = s.eventOn === true;
  document.getElementById("eventStatus").innerText = EVENT_ON ? "ON" : "OFF";
  document.getElementById("toggleEventBtn").innerText = EVENT_ON ? "TURN OFF" : "TURN ON";

  // Update the public indicator immediately
  const ind = document.getElementById("eventIndicator");
  if(ind){
    if(EVENT_ON){
      ind.innerText = "EVENT: ON";
      ind.style.background = "#16a34a";
      ind.style.color = "#000";
    } else {
      ind.innerText = "EVENT: OFF";
      ind.style.background = "#ef4444";
      ind.style.color = "#fff";
    }
  }

  REQUIRE_PARAMS = !!s.requireParams;
  document.getElementById("modeRequired").checked = REQUIRE_PARAMS;
  document.getElementById("modeTesting").checked = !REQUIRE_PARAMS;

  if(typeof s.maxWinnerGlobal !== "undefined"){
    MAX_WINNER_GLOBAL = parseInt(s.maxWinnerGlobal) || 0;
    document.getElementById("maxWinnerGlobal").value = MAX_WINNER_GLOBAL;
  }
  if(typeof s.maxWinPerDevice !== "undefined"){
    MAX_WIN_PER_DEVICE = parseInt(s.maxWinPerDevice) || 0;
    document.getElementById("maxWinDevice").value = MAX_WIN_PER_DEVICE;
  }
  if(typeof s.maxSpinPerUser !== "undefined"){
    MAX_SPIN_PER_USER = parseInt(s.maxSpinPerUser) || 0;
    document.getElementById("maxSpinDevice").value = MAX_SPIN_PER_USER;
  }
  if(typeof s.freeSpinNewUser !== "undefined"){
    document.getElementById("freeSpinNewUser").value = String(s.freeSpinNewUser);
  } else {
    document.getElementById("freeSpinNewUser").value = "";
  }

  // public URL
  PUBLIC_URL = s.publicUrl || "";
  document.getElementById("publicUrl").value = PUBLIC_URL;

  // schedule
  SCHEDULE_ENABLED = !!s.scheduleEnabled;
  SCHEDULE_START = Number(s.eventStart) || 0;
  SCHEDULE_END = Number(s.eventEnd) || 0;
  document.getElementById("enableSchedule").checked = SCHEDULE_ENABLED;
  // display schedule inputs if present
  if(SCHEDULE_START) document.getElementById("eventStart").value = (new Date(SCHEDULE_START)).toISOString().slice(0,16);
  else document.getElementById("eventStart").value = "";
  if(SCHEDULE_END) document.getElementById("eventEnd").value = (new Date(SCHEDULE_END)).toISOString().slice(0,16);
  else document.getElementById("eventEnd").value = "";

  // if schedule enabled, ensure eventOn follows schedule
  if(SCHEDULE_ENABLED && SCHEDULE_START && SCHEDULE_END){
    evaluateScheduleAndToggle();
  }

  // resetAllTimestamp handling - if newer than local, clear local spin counters for this device
  if(typeof s.resetAllTimestamp !== "undefined"){
    const t = Number(s.resetAllTimestamp) || 0;
    if(t > lastResetAll){
      spinData[deviceId] = 0;
      hasWon = false;
      localStorage.setItem("hasWon","false");
      localStorage.setItem("spinData",JSON.stringify(spinData));
      localStorage.setItem("lastResetAll",String(t));
      lastResetAll = t;
      updateInfo();

      // Juga bersihkan tampilan jadwal / waktu global (atas dan panel publik)
      try{
        const esi = document.getElementById("eventScheduleInfo");
        const et = document.getElementById("eventTimer");
        if(esi) esi.innerText = "";
        if(et) et.innerText = "";
        const pubSch = document.getElementById("publicSchedule");
        if(pubSch) pubSch.innerText = "";
      }catch(e){}
    }
  }
});

// CODES sync
db.ref("codes").on("value", snapshot=>{
 CODES = snapshot.val() || {};
});

// WHEEL ITEMS sync
const wheelItemsRef = db.ref("wheelItems");
wheelItemsRef.once("value").then(snap=>{
  if(!snap.exists()){
    const initial = prizes.map(p=>({label:p.label, win: !!p.win, weight: Number(p.weight)||1}));
    db.ref("wheelItems").set(initial);
  }
});
wheelItemsRef.on("value", snap=>{
  const items = snap.val();
  if(!items || !Array.isArray(items) || items.length === 0){
    const initial = prizes.map(p=>({label:p.label, win: !!p.win, weight: Number(p.weight)||1}));
    db.ref("wheelItems").set(initial);
    return;
  }
  prizes = [];
  for(let i=0;i<items.length;i++){
    const it = items[i] || {};
    prizes.push({ label: it.label || "ZONK", win: !!it.win, weight: (typeof it.weight !== "undefined") ? Number(it.weight) : 1 });
  }
  // safety
  const hasWin = prizes.some(p=>p.win);
  const hasLose = prizes.some(p=>!p.win);
  if(!hasWin || !hasLose){
    if(!hasLose) prizes[0].win = false;
    if(!hasWin){
      if(prizes.length < 2) prizes.push({label:"CLASS(1)", win:true, weight:1});
      else prizes[1].win = true;
    }
    const corrected = prizes.map(p=>({label:p.label, win:p.win, weight: Number(p.weight) || 1}));
    db.ref("wheelItems").set(corrected);
    return;
  }
  drawWheel();
  renderWheelListUI(items);
});

// ================= DRAW WHEEL =================
const canvas=document.getElementById("wheel");
const ctx=canvas.getContext("2d");
const c=140;
function drawWheel(){
 const slice=2*Math.PI/prizes.length;
 ctx.clearRect(0,0,canvas.width,canvas.height);
 for(let i=0;i<prizes.length;i++){
   ctx.beginPath();
   ctx.moveTo(c,c);
   ctx.fillStyle=`hsl(${Math.random()*360},80%,55%)`;
   ctx.arc(c,c,140,i*slice,(i+1)*slice);
   ctx.fill();
   ctx.save();
   ctx.translate(c,c);
   ctx.rotate(i*slice+slice/2);
   ctx.fillStyle="#000";

   const text = prizes[i].label || "";
   const baseFontSize = 12;
   const minFontSize = 8;
   const textRadius = 50;
   const availableArcLen = slice * textRadius;
   const maxTextWidth = Math.max(40, Math.min(120, availableArcLen * 0.9));

   let fontSize = baseFontSize;
   ctx.font = `bold ${fontSize}px Arial`;
   while(ctx.measureText(text).width > maxTextWidth && fontSize > minFontSize){
     fontSize--;
     ctx.font = `bold ${fontSize}px Arial`;
   }

   ctx.fillText(text,50,5);
   ctx.restore();
 }
}
drawWheel();

// ================= UTIL =================
function updateInfo(){
 document.getElementById("spinInfo").innerText =
  (spinData[deviceId]||0) > 0 ?
  `üéü Spin tersisa: ${spinData[deviceId]}` :
  `‚ö†Ô∏è Spin habis!`;
}
function saveData(){
 localStorage.setItem("spinData",JSON.stringify(spinData));
 localStorage.setItem("usedCodes",JSON.stringify(usedCodes));
 localStorage.setItem("hasWon",hasWon?"true":"false");
 localStorage.setItem("lockedName",lockedName||"");
 localStorage.setItem("totalSpin",totalSpin);
}

// weighted pick
function weightedPickIndex(indices){
  if(!Array.isArray(indices) || indices.length===0) return null;
  let total = 0;
  const weights = indices.map(i => {
    const w = Number(prizes[i].weight) || 0;
    const ww = w < 0 ? 0 : w;
    total += ww;
    return ww;
  });
  if(total <= 0) return indices[Math.floor(Math.random()*indices.length)];
  let r = Math.random()*total;
  for(let k=0;k<indices.length;k++){
    r -= weights[k];
    if(r <= 0) return indices[k];
  }
  return indices[indices.length-1];
}

// check required params before enabling event
function canEnableEvent(){
  if(!REQUIRE_PARAMS) return true;
  const info = (document.getElementById("adminInfo").value || "").trim();
  const mwg = parseInt(document.getElementById("maxWinnerGlobal").value) || 0;
  const mwd = parseInt(document.getElementById("maxWinDevice").value) || 0;
  const msp = parseInt(document.getElementById("maxSpinDevice").value) || 0;
  if(!info || mwg<=0 || mwd<=0 || msp<=0){
    return false;
  }
  return true;
}

// ================= SCHEDULE LOGIC =================
let scheduleTimerInterval = null;
function evaluateScheduleAndToggle(){
  // Only act if schedule enabled and start/end set
  if(!SCHEDULE_ENABLED || !SCHEDULE_START || !SCHEDULE_END) return;
  const now = Date.now();
  const shouldBeOn = (now >= SCHEDULE_START && now <= SCHEDULE_END);
  // if REQUIRE_PARAMS and attempting to enable, validate
  if(shouldBeOn && REQUIRE_PARAMS && !canEnableEvent()){
    // cannot enable due to missing params - keep OFF and show warning in timer area
    document.getElementById("eventTimer").innerText = "Event dijadwalkan tetapi parameter wajib belum diisi.";
    db.ref("settings/eventOn").set(false);
    return;
  }
  db.ref("settings/eventOn").set(shouldBeOn);
}

// countdown display
function startScheduleDisplay(){
  if(scheduleTimerInterval) clearInterval(scheduleTimerInterval);
  scheduleTimerInterval = setInterval(()=>{
    if(!SCHEDULE_START && !SCHEDULE_END){
      document.getElementById("eventScheduleInfo").innerText = "";
      document.getElementById("eventTimer").innerText = "";
      return;
    }
    const now = Date.now();
    let infoText = "";
    if(SCHEDULE_START && SCHEDULE_END){
      infoText = `Event waktu: ${new Date(SCHEDULE_START).toLocaleString()} ‚Üí ${new Date(SCHEDULE_END).toLocaleString()}`;
      document.getElementById("eventScheduleInfo").innerText = infoText;
      if(now < SCHEDULE_START){
        const diff = SCHEDULE_START - now;
        document.getElementById("eventTimer").innerText = `Mulai dalam: ${formatDuration(diff)}`;
      } else if(now >= SCHEDULE_START && now <= SCHEDULE_END){
        const diff = SCHEDULE_END - now;
        document.getElementById("eventTimer").innerText = `Berakhir dalam: ${formatDuration(diff)}`;
      } else {
        document.getElementById("eventTimer").innerText = `Event sudah berakhir`;
      }
    } else if(SCHEDULE_START && !SCHEDULE_END){
      infoText = `Event mulai: ${new Date(SCHEDULE_START).toLocaleString()}`;
      document.getElementById("eventScheduleInfo").innerText = infoText;
      if(now < SCHEDULE_START){
        document.getElementById("eventTimer").innerText = `Mulai dalam: ${formatDuration(SCHEDULE_START - now)}`;
      } else {
        document.getElementById("eventTimer").innerText = `Event aktif (tidak ada waktu akhir)`;
      }
    } else if(!SCHEDULE_START && SCHEDULE_END){
      infoText = `Event berakhir: ${new Date(SCHEDULE_END).toLocaleString()}`;
      document.getElementById("eventScheduleInfo").innerText = infoText;
      if(now <= SCHEDULE_END){
        document.getElementById("eventTimer").innerText = `Berakhir dalam: ${formatDuration(SCHEDULE_END - now)}`;
      } else {
        document.getElementById("eventTimer").innerText = `Event sudah berakhir`;
      }
    }
  }, 1000);
}

function formatDuration(ms){
  if(ms <= 0) return "0 detik";
  const s = Math.floor(ms/1000);
  const days = Math.floor(s/(3600*24));
  const hours = Math.floor((s%(3600*24))/3600);
  const mins = Math.floor((s%3600)/60);
  const secs = s%60;
  let parts = [];
  if(days) parts.push(days + " hari");
  if(hours) parts.push(hours + " jam");
  if(mins) parts.push(mins + " menit");
  if(secs) parts.push(secs + " detik");
  return parts.join(" ");
}

// periodically evaluate schedule to auto-toggle if enabled
setInterval(()=>{ if(SCHEDULE_ENABLED) evaluateScheduleAndToggle(); }, 5000);
startScheduleDisplay();

// ================= SPIN =================
let rot=0, lock=false;
document.getElementById("spinBtn").addEventListener("click", ()=>{
 if(lock) return;
 if((spinData[deviceId]||0) <= 0) return alert("Spin kamu habis!");
 const name = document.getElementById("name").value.trim();
 if(!name) return alert("Isi nama!");
 if(!lockedName){ lockedName = name; document.getElementById("name").disabled = true; localStorage.setItem("lockedName", lockedName); }
 totalSpin++;
 spinData[deviceId] = (spinData[deviceId]||0) - 1;
 saveData(); updateInfo();

 db.ref("winners").once("value").then(snapshot=>{
   const winnersData = snapshot.val() || [];
   db.ref("deviceWins/"+deviceId).once("value").then(dwSnap=>{
     const deviceWinsCount = dwSnap.val() || 0;
     const winPrizes = prizes.map((p,i)=>p.win?i:null).filter(i=>i!==null);
     const losePrizes = prizes.map((p,i)=>!p.win?i:null).filter(i=>i!==null);

     let forceZonk = false;
     if(!EVENT_ON) forceZonk = true;
     if(MAX_WINNER_GLOBAL>0 && winnersData.length >= MAX_WINNER_GLOBAL) forceZonk = true;
     if(MAX_WIN_PER_DEVICE>0 && deviceWinsCount >= MAX_WIN_PER_DEVICE) forceZonk = true;

     let idx;
     if(forceZonk || hasWon){
       idx = weightedPickIndex(losePrizes) || 0;
     } else {
       const allIndices = prizes.map((_,i)=>i);
       idx = weightedPickIndex(allIndices) || Math.floor(Math.random()*prizes.length);
       if(prizes[idx].win && ((MAX_WINNER_GLOBAL>0 && winnersData.length >= MAX_WINNER_GLOBAL) || (MAX_WIN_PER_DEVICE>0 && deviceWinsCount >= MAX_WIN_PER_DEVICE) || !EVENT_ON)){
         idx = weightedPickIndex(losePrizes) || idx;
       }
     }

     const anglePer = 360/prizes.length;
     const target = 90 - (idx*anglePer) - anglePer/2;
     rot += 360*6 + (target - (rot%360));
     lock = true;
     canvas.style.transform = `rotate(${rot}deg)`;

     setTimeout(()=> {
       lock = false;
       lastPrize = prizes[idx];
       document.getElementById("result").innerText = `üéâ ${lockedName} mendapatkan ${lastPrize.label}`;
       document.getElementById("log").innerHTML += `<div>${lockedName} ‚Üí ${lastPrize.label}</div>`;

       if(lastPrize.win && !hasWon && EVENT_ON){
         db.ref("winners").once("value").then(snap2=>{
           const current = snap2.val()||[];
           if(MAX_WINNER_GLOBAL===0 || current.length < MAX_WINNER_GLOBAL){
             db.ref("deviceWins/"+deviceId).once("value").then(dwSnap2=>{
               const currentDeviceWins = dwSnap2.val() || 0;
               if(MAX_WIN_PER_DEVICE===0 || currentDeviceWins < MAX_WIN_PER_DEVICE){
                 hasWon = true;
                 const timeStamp = new Date().toLocaleString();
                 current.push({name:lockedName, prize:lastPrize.label, time:timeStamp});
                 db.ref("winners").set(current);
                 db.ref("deviceWins/"+deviceId).set(currentDeviceWins+1);
                 document.getElementById("claimBtn").style.display = "block";
                 const t = encodeURIComponent(`Halo admin XREZZKYSTORE üëã\n\nSaya ${lockedName} menang:\nüéÅ ${lastPrize.label}\nüïí ${timeStamp}`);
                 window.open(`https://wa.me/${ADMIN_WA}?text=${t}`,"_blank");
               }
             });
           }
         });
       }

       if(!lastPrize.win || !hasWon) document.getElementById("claimBtn").style.display = "none";
       saveData(); updateInfo();
     }, 4200);
   });
 });
});

// ================= REDEEM CODE =================
document.getElementById("redeemBtn").addEventListener("click", ()=>{
 const codeInput = document.getElementById("code");
 const code = (codeInput.value || "").trim().toUpperCase();
 if(!code) return alert("Masukkan kode!");
 if(CODES[code]){
   const key = deviceId+"_"+code;
   if(!usedCodes[key]){
     spinData[deviceId] = (spinData[deviceId]||0) + CODES[code];
     usedCodes[key] = true;
     saveData();
     updateInfo();
     codeInput.value = "";
     alert(`‚úÖ Code ${code} berhasil! Spin +${CODES[code]}`);
   } else alert("‚ö†Ô∏è Kode sudah digunakan!");
 } else alert("‚ö†Ô∏è Kode tidak valid!");
});

// ================= CLAIM =================
document.getElementById("claimBtn").addEventListener("click", ()=>{
 if(!lastPrize || !lastPrize.win) return;
 const t = encodeURIComponent(`Halo admin XREZZKYSTORE üëã\n\nSaya ${lockedName} menang:\nüéÅ ${lastPrize.label}`);
 window.open(`https://wa.me/${ADMIN_WA}?text=${t}`,"_blank");
});

// ================= ADMIN UI =================
let tap=0;
document.getElementById("title").addEventListener("click", ()=>{
 tap++;
 if(tap>=5){
  const pin=prompt("PIN ADMIN:");
  if(pin===ADMIN_PIN) document.getElementById("adminPanel").style.display="block";
  tap=0;
 }
});

// apply settings
document.getElementById("applySettingsBtn").addEventListener("click", ()=>{
 const mwg = parseInt(document.getElementById("maxWinnerGlobal").value) || 0;
 const mwd = parseInt(document.getElementById("maxWinDevice").value) || 0;
 const msp = parseInt(document.getElementById("maxSpinDevice").value) || 0;
 const freeNew = parseInt(document.getElementById("freeSpinNewUser").value);
 const freeVal = (isNaN(freeNew) ? null : freeNew);

 db.ref("settings/maxWinnerGlobal").set(mwg);
 db.ref("settings/maxWinPerDevice").set(mwd);
 db.ref("settings/maxSpinPerUser").set(msp);
 if(freeVal !== null) db.ref("settings/freeSpinNewUser").set(freeVal);

 alert("Settings disimpan ke Firebase.");
});

// mode toggles
document.getElementById("modeRequired").addEventListener("change", ()=>{
 if(document.getElementById("modeRequired").checked) db.ref("settings/requireParams").set(true);
});
document.getElementById("modeTesting").addEventListener("change", ()=>{
 if(document.getElementById("modeTesting").checked) db.ref("settings/requireParams").set(false);
});

// manual toggle ON/OFF (legacy toggle button)
document.getElementById("toggleEventBtn").addEventListener("click", ()=>{
 const current = EVENT_ON;
 // if turning ON and REQUIRE_PARAMS true, validate
 if(!current){
   settingsRef.once("value").then(snap=>{
     const s = snap.val() || {};
     const require = !!s.requireParams;
     if(require){
       const info = (document.getElementById("adminInfo").value || "").trim();
       const mwg = parseInt(document.getElementById("maxWinnerGlobal").value) || 0;
       const mwd = parseInt(document.getElementById("maxWinDevice").value) || 0;
       const msp = parseInt(document.getElementById("maxSpinDevice").value) || 0;
       if(!info || mwg<=0 || mwd<=0 || msp<=0){
         return alert("Mode Wajib aktif: isi semua parameter (Info event, Max Pemenang Global, Max Hadiah Per Device, Max Spin Per Device) sebelum menyalakan event.");
       }
     }
     db.ref("settings/eventOn").set(!current);
   });
 } else {
   db.ref("settings/eventOn").set(false);
 }
});

// NEW: Separate explicit EVENT ON button
document.getElementById("eventOnBtn").addEventListener("click", ()=>{
 // Validate required params if in required mode
 settingsRef.once("value").then(snap=>{
   const s = snap.val() || {};
   const require = !!s.requireParams;
   if(require && !canEnableEvent()){
     return alert("Mode Wajib aktif: isi semua parameter (Info event, Max Pemenang Global, Max Hadiah Per Device, Max Spin Per Device) sebelum menyalakan event.");
   }
   // If schedule enabled and set, ensure current time is within schedule OR allow override
   if(SCHEDULE_ENABLED && SCHEDULE_START && SCHEDULE_END){
     const now = Date.now();
     if(now < SCHEDULE_START || now > SCHEDULE_END){
       if(!confirm("Schedule aktif dan sekarang berada di luar jangka waktu yang ditentukan. Tetap nyalakan event secara manual?")) return;
     }
   }
   db.ref("settings/eventOn").set(true);
   alert("Event diset ON.");
 });
});

// NEW: Separate explicit EVENT OFF button
document.getElementById("eventOffBtn").addEventListener("click", ()=>{
 if(!confirm("Matikan event sekarang?")) return;
 db.ref("settings/eventOn").set(false);
 alert("Event diset OFF.");
});

// update info board
document.getElementById("updateInfoBtn").addEventListener("click", ()=>{
 const info = (document.getElementById("adminInfo").value || "").trim();
 db.ref("infoBoard").set(info);
 alert("Info event diperbarui!");
});

// reset all data (special)
document.getElementById("resetAllDataBtn").addEventListener("click", ()=>{
 if(!confirm("‚ö†Ô∏è Data user, spin, dan pemenang akan terhapus semua. Lanjutkan?")) return;
 // set reset timestamp in settings so clients know
 const t = Date.now();
 db.ref("settings/resetAllTimestamp").set(t);
 // reset winners and deviceWins on firebase
 db.ref("winners").set([]);
 db.ref("deviceWins").set({});
 // update local state for admin (note: codes remain)
 alert("Semua data spin & pemenang dihapus. Kode redeem tetap ada.");
});

// other resets
document.getElementById("resetSpinBtn").addEventListener("click", ()=>{ if(confirm("Reset spin semua user lokal (clear localStorage)?")){ localStorage.clear(); location.reload(); }});
document.getElementById("restartWinnersBtn").addEventListener("click", ()=>{ if(confirm("Reset data pemenang di Firebase?")){ db.ref("winners").set([]); db.ref("deviceWins").set({}); alert("Pemenang di-reset."); }});

// codes management
document.getElementById("addCodeBtn").addEventListener("click", ()=>{
 const newCode = (document.getElementById("newCode").value||"").trim().toUpperCase();
 const spin = parseInt(document.getElementById("newCodeSpin").value) || 0;
 if(!newCode || spin<=0) return alert("Masukkan kode dan spin valid.");
 db.ref("codes/"+newCode).set(spin);
 alert("Kode ditambahkan.");
 document.getElementById("newCode").value=""; document.getElementById("newCodeSpin").value="";
});
document.getElementById("resetCodesBtn").addEventListener("click", ()=>{ if(confirm("Hapus semua kode redeem di Firebase?")){ db.ref("codes").set({}); alert("Semua kode dihapus."); }});

// wheel manager functions
function renderWheelListUI(items){
 const container = document.getElementById("wheelList");
 container.innerHTML = "";
 items.forEach((it, idx) => {
   const div = document.createElement("div");
   div.className = "wheel-item";
   const input = document.createElement("input");
   input.className = "label-input";
   input.value = it.label || "";
   input.placeholder = "Nama hadiah";
   input.addEventListener("change", ()=>{
     wheelItemsRef.once("value").then(snap=>{
       let arr = snap.val()||[];
       if(!Array.isArray(arr)) arr=[];
       arr[idx] = arr[idx]||{};
       arr[idx].label = input.value || "ZONK";
       db.ref("wheelItems").set(arr);
     });
   });
   const sel = document.createElement("select");
   const oWin = document.createElement("option"); oWin.value="win"; oWin.text="HADIAH";
   const oLose = document.createElement("option"); oLose.value="lose"; oLose.text="ZONK";
   sel.appendChild(oWin); sel.appendChild(oLose);
   sel.value = it.win ? "win" : "lose";
   sel.addEventListener("change", ()=>{
     wheelItemsRef.once("value").then(snap=>{
       let arr = snap.val()||[]; if(!Array.isArray(arr)) arr=[];
       arr[idx] = arr[idx]||{};
       arr[idx].win = sel.value==="win";
       const newArr = arr.map(a=>({label:a.label||"ZONK", win:!!a.win, weight: Number(a.weight)||1}));
       const hasWin = newArr.some(a=>a.win); const hasLose = newArr.some(a=>!a.win);
       if(!hasWin || !hasLose){ alert("Wheel harus memiliki minimal 1 ZONK dan 1 HADIAH."); sel.value = it.win?"win":"lose"; return; }
       db.ref("wheelItems").set(newArr);
     });
   });
   const weightInput = document.createElement("input");
   weightInput.type="number"; weightInput.min="0"; weightInput.className="weight-input";
   weightInput.value = (typeof it.weight !== "undefined") ? String(Number(it.weight)||1) : "1";
   weightInput.addEventListener("change", ()=>{
     let w = parseInt(weightInput.value); if(isNaN(w) || w<0) w=0;
     wheelItemsRef.once("value").then(snap=>{
       let arr = snap.val()||[]; if(!Array.isArray(arr)) arr=[];
       arr[idx] = arr[idx]||{};
       arr[idx].weight = w;
       db.ref("wheelItems").set(arr);
     });
   });
   const delBtn = document.createElement("button"); delBtn.innerText="Hapus";
   delBtn.addEventListener("click", ()=>{
     if(!confirm("Hapus item wheel ini?")) return;
     wheelItemsRef.once("value").then(snap=>{
       let arr = snap.val()||[]; if(!Array.isArray(arr)) arr=[];
       if(arr.length <= 1){ alert("Tidak bisa menghapus. Wheel minimal 1 item."); return; }
       const newArr = arr.slice(0,idx).concat(arr.slice(idx+1));
       const hasWin = newArr.some(a=>a && a.win); const hasLose = newArr.some(a=>a && !a.win);
       if(!hasWin || !hasLose){ alert("Tidak bisa hapus: akan menghilangkan semua ZONK atau semua HADIAH."); return; }
       db.ref("wheelItems").set(newArr);
     });
   });
   div.appendChild(input); div.appendChild(sel); div.appendChild(weightInput); div.appendChild(delBtn);
   container.appendChild(div);
 });
 if(!items || items.length===0) container.innerHTML = "<i>Tidak ada item wheel</i>";
}
document.getElementById("addWheelItemBtn").addEventListener("click", ()=>{
 const label = (document.getElementById("newWheelLabel").value||"").trim();
 const type = document.getElementById("newWheelType").value;
 let weight = parseInt(document.getElementById("newWheelWeight").value);
 if(isNaN(weight) || weight < 0) weight = 1;
 if(!label) return alert("Masukkan nama hadiah");
 wheelItemsRef.once("value").then(snap=>{
   let arr = snap.val()||[]; if(!Array.isArray(arr)) arr=[];
   arr.push({label: label, win: (type==="win"), weight: weight});
   db.ref("wheelItems").set(arr);
   document.getElementById("newWheelLabel").value=""; document.getElementById("newWheelWeight").value="1";
 });
});

// ================= SCHEDULE UI ACTIONS =================
document.getElementById("setScheduleBtn").addEventListener("click", ()=>{
 const startVal = document.getElementById("eventStart").value;
 const endVal = document.getElementById("eventEnd").value;
 const enable = document.getElementById("enableSchedule").checked;

 if(enable && !startVal && !endVal){
   return alert("Masukkan minimal tanggal mulai atau tanggal berakhir untuk schedule.");
 }

 if(!enable){
   if(!confirm("Anda menonaktifkan schedule. Lanjutkan?")) return;
 }

 if(enable && startVal){
   const s = new Date(startVal);
   if(isNaN(s)) return alert("Start datetime tidak valid");
   SCHEDULE_START = s.valueOf();
 } else SCHEDULE_START = 0;
 if(enable && endVal){
   const e = new Date(endVal);
   if(isNaN(e)) return alert("End datetime tidak valid");
   SCHEDULE_END = e.valueOf();
 } else SCHEDULE_END = 0;

 SCHEDULE_ENABLED = !!enable;
 db.ref("settings/scheduleEnabled").set(SCHEDULE_ENABLED);
 db.ref("settings/eventStart").set(SCHEDULE_START);
 db.ref("settings/eventEnd").set(SCHEDULE_END);

 // If enabled and current time inside, try to auto-enable event (respecting required params)
 if(SCHEDULE_ENABLED && SCHEDULE_START && SCHEDULE_END){
   const now = Date.now();
   if(now >= SCHEDULE_START && now <= SCHEDULE_END){
     // If required mode, validate before auto enabling
     settingsRef.once("value").then(snap=>{
       const s = snap.val() || {};
       const require = !!s.requireParams;
       if(require && !canEnableEvent()){
         alert("Schedule disimpan. Namun event tidak bisa otomatis ON karena parameter wajib belum diisi.");
         db.ref("settings/eventOn").set(false);
       } else {
         db.ref("settings/eventOn").set(true);
         alert("Schedule disimpan. Event otomatis dinyalakan sesuai schedule (sekarang masuk jangka waktu).");
       }
     });
   } else {
     // outside scheduled window: ensure event is OFF until start
     db.ref("settings/eventOn").set(false);
     alert("Schedule disimpan. Event akan otomatis ON saat waktunya tiba.");
   }
 } else {
   alert("Schedule disimpan.");
 }

 // start display & evaluate immediately
 startScheduleDisplay();
 evaluateScheduleAndToggle();
});

document.getElementById("clearScheduleBtn").addEventListener("click", ()=>{
 if(!confirm("Hapus schedule event?")) return;
 SCHEDULE_ENABLED=false; SCHEDULE_START=0; SCHEDULE_END=0;
 db.ref("settings/scheduleEnabled").set(false);
 db.ref("settings/eventStart").set(0);
 db.ref("settings/eventEnd").set(0);
 document.getElementById("eventStart").value="";
 document.getElementById("eventEnd").value="";
 startScheduleDisplay();
 alert("Schedule dihapus.");
});

// ================= PUBLIC LINK ACTIONS =================
document.getElementById("setPublicUrlBtn").addEventListener("click", ()=>{
 const u = (document.getElementById("publicUrl").value || "").trim();
 db.ref("settings/publicUrl").set(u);
 alert("Public URL disimpan.");
});
document.getElementById("openPublicBtn").addEventListener("click", ()=>{
 db.ref("settings/publicUrl").once("value").then(snap=>{
   const url = (snap.val()||"").trim();
   const openUrl = url || (window.location.origin + window.location.pathname + '?public=1');
   window.open(openUrl, "_blank");
 });
});
document.getElementById("copyPublicBtn").addEventListener("click", ()=>{
 db.ref("settings/publicUrl").once("value").then(snap=>{
   let url = (snap.val()||"").trim();
   if(!url) url = window.location.origin + window.location.pathname + '?public=1';
   if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(url).then(()=> alert("Link publik disalin.")); }
   else { try{ const ta=document.createElement('textarea'); ta.value=url; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert("Link publik disalin (fallback)."); }catch(e){ alert("Gagal salin link: "+url); } }
 });
});

// ================= EXPORT / COPY =================
document.getElementById("exportBtn").addEventListener("click", ()=>{
 db.ref("winners").once("value").then(snapshot=>{
   const data = snapshot.val()||[];
   if(!data || data.length===0){ document.getElementById("exportArea").value = "Belum ada pemenang."; }
   else {
     let t = "DAFTAR PEMENANG:\n\n";
     data.forEach((w,i)=> t += `${i+1}. ${w.name} - ${w.prize} - ${w.time}\n`);
     document.getElementById("exportArea").value = t;
   }
   document.getElementById("exportModal").style.display = "flex";
   document.getElementById("exportStatus").innerText = `Jumlah pemenang: ${ (data && data.length) || 0 }`;
 });
});
document.getElementById("copyExportBtn").addEventListener("click", ()=>{
 const text = document.getElementById("exportArea").value || "";
 if(!text) return alert("Tidak ada yang disalin.");
 if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(text).then(()=> alert("Teks pemenang disalin.")); }
 else { const ta=document.getElementById("exportArea"); ta.select(); try{ document.execCommand('copy'); alert("Teks pemenang disalin (fallback)."); }catch(e){ alert("Gagal salin. Salin manual."); } }
});
document.getElementById("closeExportBtn").addEventListener("click", ()=>{ document.getElementById("exportModal").style.display = "none"; });

// ================= REALTIME WINNERS & INFO =================
db.ref("infoBoard").on("value", snap => {
 const info = snap.val()||"Belum ada info event";
 document.getElementById("infoBoard").innerHTML = "<b>INFO EVENT:</b><br>"+info;
 // pastikan admin textarea selalu sinkron realtime
 try{ document.getElementById("adminInfo").value = info; }catch(e){}
});
db.ref("winners").on("value", snap => {
 const winners = snap.val()||[];
 if(!winners || winners.length===0) document.getElementById("globalWinners").innerHTML = "<b>Pemenang:</b><br>Belum ada pemenang";
 else {
   let html = "<b>Pemenang:</b><br>";
   winners.forEach((w,i)=> html += `${i+1}. ${w.name} - ${w.prize} (${w.time})<br>`);
   document.getElementById("globalWinners").innerHTML = html;
 }
 if(MAX_WINNER_GLOBAL>0 && winners.length >= MAX_WINNER_GLOBAL){
   document.getElementById("winnersStatus").innerText = "‚ö†Ô∏è Pemenang telah tercapai. Event tidak menerima pemenang baru, peserta masih dapat spin namun hasil akan ZONK.";
 } else document.getElementById("winnersStatus").innerText = "";
 document.getElementById("exportStatus").innerText = `Jumlah pemenang sekarang: ${winners.length}`;
});
updateInfo();
</script>

<!-- Add-on script (lightweight, non-destructive) -->
<script>
(function(){
  if(typeof db === "undefined") return;
  const settingsRefLocal = db.ref("settings");
  const winnersRefLocal = db.ref("winners");
  const wheelItemsRefLocal = db.ref("wheelItems");

  // Enhanced Schedule / Auto ON-OFF logic + UI coloring + reset handling + winner modal + admin winner manager
  let enhancedInterval = null;
  let localLastReset = parseInt(localStorage.getItem('lastResetAll')||'0',10) || 0;

  function msParts(ms){
    if(ms < 0) ms = 0;
    const s = Math.floor(ms/1000);
    const days = Math.floor(s/(3600*24));
    const hours = Math.floor((s%(3600*24))/3600);
    const mins = Math.floor((s%3600)/60);
    const secs = s%60;
    return {days,hours,mins,secs};
  }

  function formatParts(p){
    return `${p.days} Hari ${String(p.hours).padStart(2,'0')} Jam ${String(p.mins).padStart(2,'0')} Menit ${String(p.secs).padStart(2,'0')} Detik`;
  }

  function setTimerColor(el, colorClass){
    if(!el) return;
    el.classList.remove('green','yellow','red','gray');
    // We'll use inline background for compatibility
    if(colorClass === 'green'){ el.style.background = '#16a34a'; el.style.color='#000'; el.style.padding='6px'; el.style.borderRadius='8px'; }
    else if(colorClass === 'yellow'){ el.style.background = '#f59e0b'; el.style.color='#000'; el.style.padding='6px'; el.style.borderRadius='8px'; }
    else if(colorClass === 'red'){ el.style.background = '#ef4444'; el.style.color='#fff'; el.style.padding='6px'; el.style.borderRadius='8px'; }
    else { el.style.background = ''; el.style.color=''; el.style.padding=''; el.style.borderRadius=''; }
  }

  function startEnhancedScheduleLoop(){
    if(enhancedInterval) clearInterval(enhancedInterval);
    enhancedInterval = setInterval(()=>{
      // read schedule values directly from Firebase (to ensure we use authoritative state)
      settingsRefLocal.once('value').then(snap=>{
        const s = snap.val() || {};
        const start = Number(s.eventStart) || 0;
        const end = Number(s.eventEnd) || 0;
        const enabled = !!s.scheduleEnabled;
        const now = Date.now();

        // Always show times when set (public must see)
        try{
          const pubSch = document.getElementById('publicSchedule');
          if(pubSch){
            if(start && end) pubSch.innerText = `Event waktu: ${new Date(start).toLocaleString()} ‚Üí ${new Date(end).toLocaleString()}`;
            else if(start) pubSch.innerText = `Event mulai: ${new Date(start).toLocaleString()}`;
            else if(end) pubSch.innerText = `Event berakhir: ${new Date(end).toLocaleString()}`;
            else pubSch.innerText = `Waktu event: belum diset`;
          }
        }catch(e){}

        const timerEl = document.getElementById('eventTimer');
        const scheduleInfoEl = document.getElementById('eventScheduleInfo');
        if(!start && !end){
          // no schedule: keep UI minimal
          if(scheduleInfoEl) scheduleInfoEl.innerText = '';
          if(timerEl) { timerEl.innerText = ''; setTimerColor(timerEl,null); }
          return;
        }

        // Ensure schedule info displayed above wheel
        if(scheduleInfoEl){
          if(start && end) scheduleInfoEl.innerText = `Event waktu: ${new Date(start).toLocaleString()} ‚Üí ${new Date(end).toLocaleString()}`;
          else if(start) scheduleInfoEl.innerText = `Event mulai: ${new Date(start).toLocaleString()}`;
          else if(end) scheduleInfoEl.innerText = `Event berakhir: ${new Date(end).toLocaleString()}`;
        }

        if(now < start){
          // EVENT BELUM MULAI
          const diff = start - now;
          const p = msParts(diff);
          if(timerEl) { timerEl.innerText = `üü¢ Event akan segera dimulai ‚Äî ${formatParts(p)}`; setTimerColor(timerEl,'green'); }
          // Do not set eventOn true yet
        } else if(now >= start && now <= end){
          // EVENT BERJALAN
          const diff = end - now;
          const p = msParts(diff);
          // Apply color rules
          if(diff <= 10000){
            if(timerEl) { timerEl.innerText = `‚õî DETIK TERAKHIR ‚Äî ${formatParts(p)}`; setTimerColor(timerEl,'red'); }
          } else if(diff <= 24*3600*1000){
            if(timerEl) { timerEl.innerText = `‚ö†Ô∏è EVENT AKAN BERAKHIR ‚Äî ${formatParts(p)}`; setTimerColor(timerEl,'yellow'); }
          } else {
            if(timerEl) { timerEl.innerText = `‚è∞ EVENT BERJALAN ‚Äî ${formatParts(p)}`; setTimerColor(timerEl,'green'); }
          }
          // Ensure event is ON
          if(!s.eventOn){
            // Validate required params if needed (only auto-enable if schedule enabled)
            if(!s.requireParams || (s.requireParams && canEnableEvent())){
              settingsRefLocal.child('eventOn').set(true).catch(()=>{});
            } else {
              // keep off and show warning
              if(timerEl && s.requireParams) timerEl.innerText = `Event dijadwalkan tetapi parameter wajib belum diisi.`;
            }
          }
        } else {
          // now > end => Event finished by time
          if(timerEl) { timerEl.innerText = `üõë EVENT SELESAI ‚Äî ‚ùå Event telah berakhir`; setTimerColor(timerEl,'gray'); }
          // Ensure event is OFF
          if(s.eventOn) settingsRefLocal.child('eventOn').set(false).catch(()=>{});
          // We mark eventEnd time (already set) and do not restart
        }
      }).catch(()=>{});
    }, 800);
  }
  startEnhancedScheduleLoop();

  // If resetAllTimestamp changes, clear schedule keys in Firebase (so admin reset removes times)
  settingsRefLocal.child('resetAllTimestamp').on('value', snap=>{
    const t = Number(snap.val()) || 0;
    if(!t) return;
    if(t <= localLastReset) return;
    localLastReset = t;
    // Clear schedule & eventOn as requested
    settingsRefLocal.update({ eventStart:0, eventEnd:0, scheduleEnabled:false, eventOn:false }).catch(()=>{});
    try{
      const esi = document.getElementById('eventScheduleInfo'); if(esi) esi.innerText = '';
      const et = document.getElementById('eventTimer'); if(et) et.innerText = '';
      const pubSch = document.getElementById('publicSchedule'); if(pubSch) pubSch.innerText = '';
    }catch(e){}
  });

  // Winners full check (ensure event off if winners reached)
  winnersRefLocal.on('value', snap=>{
    const arr = snap.val() || [];
    const winners = Array.isArray(arr) ? arr.filter(Boolean) : Object.values(arr||{});
    const count = winners.length;
    if(MAX_WINNER_GLOBAL > 0 && count >= MAX_WINNER_GLOBAL){
      // Immediately end event due to winners full
      settingsRefLocal.update({ eventOn:false, endedDueToFull:true }).catch(()=>{});
      // Update timer UI
      try{
        const timerEl = document.getElementById('eventTimer');
        if(timerEl) { timerEl.innerText = '‚ùå Event berakhir (pemenang tercapai)'; setTimerColor(timerEl,'gray'); }
        const status = document.getElementById('winnersStatus');
        if(status) status.innerText = '‚ö†Ô∏è Event telah berakhir: pemenang penuh';
        // Ensure claim disabled for public
        try{ document.getElementById('claimBtn').style.display = 'none'; }catch(e){}
      }catch(e){}
    }
    // Re-render clickable winners list (so modal can open)
    renderClickableWinners(winners);
  });

  // Create winner modal (if not present) dynamically
  function ensureWinnerModal(){
    if(document.getElementById('winnerModal')) return;
    const modal = document.createElement('div');
    modal.id = 'winnerModal';
    modal.style.display = 'none';
    modal.style.position = 'fixed';
    modal.style.left = '0';
    modal.style.top = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.background = 'rgba(0,0,0,0.6)';
    modal.style.zIndex = '20000';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    modal.innerHTML = `
      <div id="winnerContent" style="width:320px;background:#071414;border:1px solid #00ffd5;padding:12px;border-radius:8px;color:#fff;">
        <div style="font-weight:bold;margin-bottom:8px">Detail Pemenang</div>
        <div id="winnerList"></div>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="closeWinnerModal">Tutup</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('closeWinnerModal').addEventListener('click', ()=>{ modal.style.display='none'; });
  }
  ensureWinnerModal();

  function renderClickableWinners(winners){
    try{
      const container = document.getElementById('globalWinners');
      if(!container) return;
      if(!winners || winners.length === 0){ container.innerHTML = '<b>Pemenang:</b><br>Belum ada pemenang'; return; }
      // Build clickable list sorted by weight (highest weight first)
      // Fetch weight map
      wheelItemsRefLocal.once('value').then(snap=>{
        const items = snap.val() || [];
        const weightMap = {};
        (Array.isArray(items) ? items : Object.values(items||[])).forEach(it=>{ if(it && it.label) weightMap[it.label] = Number(it.weight)||1; });
        // sort winners by prize weight desc
        const sorted = winners.slice().sort((a,b)=>{
          const wa = weightMap[a.prize] || 0;
          const wb = weightMap[b.prize] || 0;
          if(wb !== wa) return wb - wa;
          return (new Date(a.time).getTime() || 0) - (new Date(b.time).getTime() || 0);
        });
        let html = '<b>Pemenang:</b><br>';
        sorted.forEach((w,i)=>{
          const safeName = escapeHtml(w.name||'');
          const safePrize = escapeHtml(w.prize||'');
          const safeTime = escapeHtml(w.time||'');
          html += `<div class="winner-entry" data-index="${i}" data-name="${safeName}" data-prize="${safePrize}" data-time="${safeTime}" style="cursor:pointer;padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)">${i+1}. ${safeName} - ${safePrize} (${safeTime})</div>`;
        });
        container.innerHTML = html;
        // Attach click handlers
        const entries = container.querySelectorAll('.winner-entry');
        entries.forEach(el=>{
          el.removeEventListener('click', onWinnerClick);
          el.addEventListener('click', onWinnerClick);
        });
      });
    }catch(e){}
  }

  function onWinnerClick(e){
    const el = e.currentTarget;
    const name = el.dataset.name;
    const prize = el.dataset.prize;
    const time = el.dataset.time;
    const modal = document.getElementById('winnerModal');
    if(!modal) return;
    const list = document.getElementById('winnerList');
    if(list){
      list.innerHTML = '';
      const div = document.createElement('div');
      div.className = 'winner-row';
      div.style.padding = '8px';
      div.innerHTML = `<b>Nama:</b> ${name}<br><b>Hadiah:</b> ${prize}<br><b>Waktu:</b> ${time || '-'}`;
      list.appendChild(div);
      // add admin actions if adminPanel visible
      if(document.getElementById('adminPanel') && document.getElementById('adminPanel').style.display !== 'none'){
        const adminActions = document.createElement('div');
        adminActions.style.marginTop = '8px';
        const copyBtn = document.createElement('button'); copyBtn.textContent = 'Copy Data';
        copyBtn.addEventListener('click', ()=>{ copyText(`${name} - ${prize} - ${time}`); alert('Data pemenang disalin.'); });
        adminActions.appendChild(copyBtn);
        list.appendChild(adminActions);
      }
    }
    modal.style.display = 'flex';
  }

  function copyText(txt){
    if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(txt).catch(()=>{}); }
    else{ try{ const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);}catch(e){} }
  }

  function escapeHtml(s){
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // Ensure public sees schedule & status on load
  settingsRefLocal.on('value', snap=>{
    const s = snap.val() || {};
    const start = Number(s.eventStart) || 0;
    const end = Number(s.eventEnd) || 0;
    const on = !!s.eventOn;
    const pubSchedule = document.getElementById('publicSchedule');
    if(pubSchedule){
      if(start && end) pubSchedule.innerText = `Event waktu: ${new Date(start).toLocaleString()} ‚Üí ${new Date(end).toLocaleString()}`;
      else if(start) pubSchedule.innerText = `Event mulai: ${new Date(start).toLocaleString()}`;
      else if(end) pubSchedule.innerText = `Event berakhir: ${new Date(end).toLocaleString()}`;
      else pubSchedule.innerText = 'Waktu event: belum diset';
    }
    setIndicator(on);
  });

  // Initial render of clickable winners
  winnersRefLocal.once('value').then(snap=>{
    const arr = snap.val() || [];
    const winners = Array.isArray(arr) ? arr.filter(Boolean) : Object.values(arr||{});
    renderClickableWinners(winners);
  });

})();
</script>
</body>
 </html>
